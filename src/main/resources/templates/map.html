<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Bản đồ dịch vụ</title>
    <script async defer
        src="https://maps.gomaps.pro/maps/api/js?key=AlzaSymd04nEXFHqc1-lWvkUWcMihigYWV4vgYi&libraries=places&callback=initMap"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div id="map" style="height:1000px"></div>

    <!-- Modal nhập dịch vụ -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="serviceForm" class="modal-content" method="post" th:action="@{/add}">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm dịch vụ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="latitude" id="lat">
                    <input type="hidden" name="longitude" id="lng">
                    <div class="mb-3">
                        <label>Tên dịch vụ</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Mô tả</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Lưu</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal nhập dịch vụ -->
    <script>
        let map;
        let allMarkers = [];
        let latClicked = 0, lngClicked = 0;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 8.6955, lng: 106.6018 }, // Côn Đảo
                zoom: 13
            });

            loadMarkers();

            map.addListener("click", (e) => {
                latClicked = e.latLng.lat();
                lngClicked = e.latLng.lng();

                document.getElementById("lat").value = latClicked;
                document.getElementById("lng").value = lngClicked;

                const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
                modal.show();
            });

        }

        // Load lại tất cả marker từ backend
        function loadMarkers() {
            // Xóa marker cũ
            allMarkers.forEach(m => m.setMap(null));
            allMarkers = [];

            fetch("/api/tourism/all")
                .then(res => res.json())
                .then(data => {
                    data.forEach(service => {
                        const m = new google.maps.Marker({
                            position: { lat: service.latitude, lng: service.longitude },
                            map: map,
                            title: service.name
                        });

                        const info = new google.maps.InfoWindow({
                            content: `<strong>${service.name}</strong><br>${service.description}`
                        });

                        m.addListener("click", () => info.open(map, m));
                        allMarkers.push(m);
                    });
                });
        }

        window.onload = initMap;
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>

</html>