<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Bản đồ dịch vụ</title>
    <script async defer
        src="https://maps.gomaps.pro/maps/api/js?key=AlzaSymd04nEXFHqc1-lWvkUWcMihigYWV4vgYi&libraries=places&callback=initMap"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        #map {
            width: 100%;
            height: 1000px;
        }

        .offcanvas {
            max-width: 400px;
        }

        @media (max-width: 768px) {
            .offcanvas {
                max-width: 100%;
                height: 50%;
            }
        }

        #imagePreview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .offcanvas-header {
            border-bottom: 1px solid #ddd;
        }

        .offcanvas-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .offcanvas-body {
            padding: 15px;
        }

        #sidebar-description {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .main-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .image-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .image-gallery::-webkit-scrollbar {
            height: 6px;
        }

        .image-gallery::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        #sidebar-map-link {
            font-size: 14px;
        }

        .main-image.fade-in {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .main-image.show {
            opacity: 1;
        }

        .preview-image:hover {
            cursor: pointer;
            transform: scale(1.05);
            transition: transform 0.2s;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="map"></div>

        <!-- Offcanvas Sidebar -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="sidebar-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <p id="sidebar-description" class="text-muted"></p>
                <div id="sidebar-images"></div>
                <a id="sidebar-map-link" href="#" target="_blank" class="btn btn-outline-primary w-100 mt-3">Xem trên
                    Google Maps</a>
            </div>
        </div>
    </div>

    <!-- Modal nhập dịch vụ -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="serviceForm" class="modal-content" method="post" th:action="@{/add}"
                enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">New Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="latitude" id="lat">
                    <input type="hidden" name="longitude" id="lng">
                    <div class="mb-3">
                        <label>Name</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Description</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="imageLocation" class="form-label">Image of location:</label>
                        <input class="form-control" type="file" id="imageLocation" accept=".png, .jpg, .jpeg"
                            name="imageLocation" multiple />
                        <div id="imagePreview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let map;
        let allMarkers = [];
        let latClicked = 0, lngClicked = 0;
        let sidebar = new bootstrap.Offcanvas(document.getElementById('sidebar'));

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 8.6955, lng: 106.6018 },
                zoom: 13,
                mapTypeId: 'satellite',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "all",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            loadMarkers();

            map.addListener("click", (e) => {
                latClicked = e.latLng.lat();
                lngClicked = e.latLng.lng();
                document.getElementById("lat").value = latClicked;
                document.getElementById("lng").value = lngClicked;
                new bootstrap.Modal(document.getElementById('serviceModal')).show();
            });

            document.getElementById('imageLocation').addEventListener('change', () => {
                const imagePreview = document.getElementById('imagePreview');
                const files = imageLocation.files;
                imagePreview.innerHTML = '';
                if (files.length > 4) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tối đa 4 hình ảnh!',
                        text: 'Vui lòng chọn không quá 4 ảnh.'
                    });
                    imageInput.value = '';
                    return;
                }
                for (const file of files) {
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-image';
                            imagePreview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        }

        function loadMarkers() {
            allMarkers.forEach(m => m.setMap(null));
            allMarkers = [];

            fetch("/api/tourism/all")
                .then(res => res.json())
                .then(data => {
                    data.forEach(service => {
                        const marker = new google.maps.Marker({
                            position: { lat: service.latitude, lng: service.longitude },
                            map: map,
                            title: service.name,
                            label: {
                                text: service.name,
                                color: "#FFFFFF",
                                fontSize: "14px",
                                fontWeight: "bold"
                            }
                        });

                        marker.addListener("click", () => {
                            document.getElementById("sidebar-title").innerText = service.name;
                            document.getElementById("sidebar-description").innerText = service.description;
                            document.getElementById("sidebar-map-link").href = `https://www.google.com/maps?q=${service.latitude},${service.longitude}`;

                            const imageContainer = document.getElementById("sidebar-images");
                            imageContainer.innerHTML = 'Đang tải ảnh...';

                            fetch(`/api/tourism/images/${service.id}`)
                                .then(res => res.json())
                                .then(images => {
                                    imageContainer.innerHTML = '';

                                    if (images.length > 0) {
                                        // Ảnh chính
                                        const mainImg = document.createElement('img');
                                        mainImg.src = images[0].imagePath;
                                        mainImg.className = 'main-image';
                                        imageContainer.appendChild(mainImg);

                                        // Các ảnh nhỏ
                                        const gallery = document.createElement('div');
                                        gallery.className = 'image-gallery';
                                        images.slice(0).forEach(img => {
                                            const imgElement = document.createElement('img');
                                            imgElement.src = img.imagePath;
                                            imgElement.className = 'preview-image';
                                            imgElement.addEventListener('click', () => {
                                                mainImg.classList.remove('show');
                                                mainImg.classList.add('fade-in');
                                                mainImg.src = img.imagePath;
                                                // Đợi load ảnh xong rồi fade in
                                                mainImg.onload = () => {
                                                    mainImg.classList.remove('fade-in');
                                                    mainImg.classList.add('show');
                                                };
                                            });
                                            gallery.appendChild(imgElement);
                                        });
                                        imageContainer.appendChild(document.createElement('hr'));
                                        imageContainer.appendChild(gallery);
                                    } else {
                                        imageContainer.innerText = 'Không có ảnh';
                                    }
                                })
                                .catch(err => {
                                    console.error('Lỗi khi lấy ảnh:', err);
                                    imageContainer.innerText = 'Lỗi tải ảnh';
                                });

                            sidebar.show();
                            google.maps.event.trigger(map, "resize");
                        });

                        allMarkers.push(marker);
                    });
                });
        }

        window.onload = initMap;
    </script>
</body>

</html>