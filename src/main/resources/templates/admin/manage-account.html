<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <title>Admin-Manage Account</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">

  <!-- Favicon -->
  <link href="img/favicon.ico" rel="icon">

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icon Font Stylesheet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Libraries Stylesheet -->
  <link href="/manager/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

  <!-- Customized Bootstrap Stylesheet -->
  <link href="/manager/css/bootstrap.min.css" rel="stylesheet">

  <!-- Template Stylesheet -->
  <link href="/manager/css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css"
    integrity="sha512-6S2HWzVFxruDlZxI3sXOZZ4/eJ8AcxkQH1+JjSe/ONCEqR9L4Ysq5JdT5ipqtzU7WHalNwzwBv+iE51gNHJNqQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <div class="container-fluid position-relative bg-white d-flex p-0">
    <!-- Spinner Start -->
    <div th:replace="~{layout/spinner-recruiter :: spinner-recruiter}"></div>
    <!-- Spinner End -->


    <!-- Sidebar Start -->
    <div th:replace="~{layout/sidebar-admin :: sidebar-admin}"></div>
    <!-- Sidebar End -->


    <!-- Content Start -->
    <div class="content">
      <!-- Navbar Start -->
      <div th:replace="~{layout/navbar-recruiter :: navbar-recruiter}"></div>
      <!-- Navbar End -->


      <!-- Mở đầu phần chính -->
      <div class="container-fluid pt-4 px-4">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Tài khoản</li>
          </ol>
        </nav>
        <!-- Viết code vào đây -->
        <div class="bg-light rounded h-100 p-4">
          <h6 class="mb-4">Quản lí tài khoản</h6>
          <div class="table-responsive">
            <!-- Danh sách công ty ẩn (sẽ được tải sẵn khi trang load) -->
            <select id="companyList" style="display: none;">
              <option value="" disabled selected>Đang tải danh sách công ty...</option>
            </select>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Mã số</th>
                  <th scope="col">Họ và tên</th>
                  <th scope="col">Công ty</th>
                  <th scope="col">Vai trò</th>
                  <th scope="col">Tình trạng</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <div th:if="${users.isEmpty()}">
                  <tr>
                    <td colspan="6" class="text-center">Không có dữ liệu</td>
                  </tr>
                </div>
                <tr th:each="user : ${users}">
                  <td th:text="${user.id}"></td>
                  <td th:text="${user.fullName}"></td>
                  <td th:text="${user.workingCompany != null ? user.workingCompany.name : ''}"></td>
                  <td th:text="${user.role.name}"></td>
                  <td th:text="${user.isActivated ? 'Đang hoạt động' : 'Chưa kích hoạt'}"
                    th:style="${user.isActivated ? 'color: green;' : 'color: red;'}"></td>
                  <td>
                    <a th:href="@{/admin/account/activate/{id}(id=${user.id})}" th:if="${user.isActivated != true}"
                      class="btn btn-sm btn-primary">Kích hoạt</a>
                    <a th:href="@{/admin/account/deactivate/{id}(id=${user.id})}" th:if="${user.isActivated == true}"
                      class="btn btn-sm btn-danger">Hủy kích hoạt</a>
                    <a th:href="@{/admin/account/user-detail/{id}(id=${user.id})}" class="btn btn-sm btn-warning">Chi
                      tiết</a>
                    <button class="btn btn-sm btn-secondary" th:if="${user.role != null and user.role.name != 'Admin'}"
                      th:data-id="${user.id}" onclick="openChangeRoleModal(this)">
                      Chuyển vai trò
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <!-- Pagination -->
            <nav aria-label="Pagination navigation">
              <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                  <a class="page-link" th:href="@{/admin/account(page=${currentPage-1})}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                  th:classappend="${currentPage == i} ? 'active'">
                  <a class="page-link" th:href="@{/admin/account(page=${i})}" th:text="${i}"></a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                  <a class="page-link" th:href="@{/admin/account(page=${currentPage+1})}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </nav>
            <!-- End Pagination -->
            <div colspan="6">
              <a th:href="@{/admin/account/add-user}" class="btn btn-sm btn-success">Thêm tài khoản mới</a>
            </div>
          </div>
        </div>
      </div>
      <!-- Kết thúc phần chính -->

      <!-- Modal Change Role -->
      <div class="modal fade" id="changeRoleModal" tabindex="-1" aria-labelledby="changeRoleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="changeRoleModalLabel">Chuyển Vai Trò</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="changeRoleForm" th:action="@{/admin/account/change-role}" method="post">
                <!-- User ID (readonly) -->
                <div class="mb-3" style="display: none;">
                  <label for="userId" class="form-label">User ID</label>
                  <input type="text" class="form-control" id="userId" name="userId" readonly>
                </div>

                <!-- Danh sách công ty -->
                <div class="mb-3 form-group">
                  <label for="exampleInputCompany" class="form-label">Công ty</label>
                  <select class="form-select" id="exampleInputCompany" name="companyId">
                    <option value="" selected>Chọn công ty</option>
                  </select>
                </div>

                <!-- Chọn vai trò -->
                <div class="mb-3 form-group">
                  <label for="role" class="form-label">Vai Trò</label>
                  <select class="form-select" id="role" name="role">
                    <option value="Recruiter">Nhà tuyển dụng</option>
                    <option value="Seeker">Người tìm việc</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- End Modal Change Role -->

      <!-- Footer Start -->
      <div th:replace="~{layout/footer-recruiter :: footer-recruiter}"></div>
      <!-- Footer End -->
    </div>
    <!-- Content End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"
    integrity="sha512-lbwH47l/tPXJYG9AcFNoJaTMhGvYWhVM9YI43CT+uteTRRaiLCui8snIgyAN8XWgNjNhCqlAUdzZptso6OCoFQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Template Javascript -->
  <script src="/manager/js/main.js"></script>
  <!-- Javascript for modal -->
  <script>
    // Khi trang web tải xong, gọi API để lấy danh sách công ty
    document.addEventListener("DOMContentLoaded", function () {
      fetch('/admin/api/companies')
        .then(response => response.json()) // Chuyển đổi dữ liệu JSON
        .then(data => {
          let companyList = document.getElementById("companyList");
          companyList.innerHTML = ''; // Xóa danh sách cũ (nếu có)
          console.log(data);
          // Thêm công ty vào danh sách ẩn
          data.forEach(company => {
            let option = document.createElement("option");
            option.value = company.id;
            option.textContent = company.name;
            companyList.appendChild(option);
          });

          console.log("Danh sách công ty đã tải xong!");
        })
        .catch(error => console.error('Lỗi khi lấy danh sách công ty:', error));
    });

    // Khi bấm nút "Chuyển vai trò", mở modal & lấy dữ liệu user
    function openChangeRoleModal(button) {
      var userId = button.getAttribute("data-id"); // Lấy ID của user từ button
      document.getElementById("userId").value = userId; // Điền vào modal

      // Copy danh sách công ty đã tải trước đó vào dropdown trong modal
      let companyDropdown = document.getElementById("exampleInputCompany");
      companyDropdown.innerHTML = document.getElementById("companyList").innerHTML;

      // Mở modal Bootstrap
      var modal = new bootstrap.Modal(document.getElementById('changeRoleModal'));
      modal.show();
    }
    $(document).ready(function () {
      $("#role").change(function () {
        var selectedRole = $(this).val(); // Lấy giá trị role đã chọn

        if (selectedRole === "Seeker") {
          $("#exampleInputCompany").parent().hide(); // Ẩn trường chọn công ty
          $("#exampleInputCompany").val(""); // Reset giá trị
        } else {
          $("#exampleInputCompany").parent().show(); // Hiển thị lại nếu chọn role khác
        }
      });
    });
  </script>
  <!-- End Javascript for modal -->
</body>

</html>